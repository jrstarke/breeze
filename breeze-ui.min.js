(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x=function(e,t){return function(){return e.apply(t,arguments)}},T={}.hasOwnProperty,N=function(e,t){function r(){this.constructor=e}for(var n in t){if(T.call(t,n))e[n]=t[n]}r.prototype=t.prototype;e.prototype=new r;e.__super__=t.prototype;return e};S=function(e,t,n){if(n==null){n=null}mixpanel.track(e,t);if(n){return n()}};d=function(e,t,n){p(t,n.source,n.url);return S(t,n,function(){return window.open(e.href,"_blank")})};window.recordOutboundLink=d;p=function(e,t,n){return _gat._getTrackerByName()._trackEvent(e,t,n)};window.recordEvent=p;m=function(e,t,n){return _gaq.push(["_setCustomVar",e,t,n,2])};window.setVariable=m;if(Modernizr.svg&&Modernizr.inlinesvg){if($(window).height()<500||$(window).width()<500){$(".desktop").hide()}if(Modernizr.touch){$(".github").hide()}$(".header").show();a=function(e){if($("#standard-options").is(":visible")){$("#standard-options").hide("slow");$(e).button("option","icons",{primary:"ui-icon-triangle-1-s"});return S("hid options")}else{$("#standard-options").show("slow");$(e).button("option","icons",{primary:"ui-icon-triangle-1-n"});return S("show options")}};$(".header-expand").button({icons:{primary:"ui-icon ui-icon-triangle-1-n"},text:false}).click(function(){return a(this)});E=function(){if($("#additional-notices").is(":visible")){$("#additional-notices").hide("slow");$("a#additional-expand").text("additional notices");return S("hid notices")}else{$("#additional-notices").show("slow");$("a#additional-expand").text("less notices");return S("show notices")}};$("a#additional-expand").click(function(){return E()});h=org.polymaps;c=h.map().container(d3.select("#map").append("svg:svg").attr("width","100%").attr("height","100%").node()).zoom(13).center({lat:48.455164,lon:-123.351059}).add(h.drag()).add(h.wheel().smooth(false)).add(h.dblclick()).add(h.arrow()).add(h.touch());c.add(h.image().url(h.url("http://tile.stamen.com/toner/{Z}/{X}/{Y}.png")));r=function(){function e(e){var t=this;this.map=e;this.transform=x(this.transform,this);this.selector=d3.select("#map svg").insert("svg:g");this.map.on("move",function(){return t.update()});this.map.on("resize",function(){return t.update()})}e.prototype.zoomLevel=function(){return this.map.zoom()};e.prevZoom=13;e.distance=0;e.prototype.pixelDistance=function(){var e,t;e=this.map.pointLocation({x:0,y:0});t=this.map.pointLocation({x:1,y:1});this.distance={lat:Math.abs(e.lat-t.lat),lon:Math.abs(e.lon-t.lon)};return this.distance};e.prototype.transform=function(e){var t;t=this.map.locationPoint(e);return"translate("+t.x+","+t.y+")"};e.prototype.cluster=function(e,t){var n,r,i,s,o,u,a,f,l;s=e.slice(0);f=this.pixelDistance();o=t*f.lat;u=t*f.lon;i=[];while(s.length>0){l=s.shift();r=[];r.push(l);a=0;while(a<s.length){if(Math.abs(s[a].lat-l.lat)<o&&Math.abs(s[a].lon-l.lon)<u){n=s.splice(a,1);r.push(n[0]);a--}a++}i.push(r)}return i};e.prototype.filter=function(e,t){var n,r,i,s;s=this.map.pointLocation({x:0-t,y:0-t});n=this.map.pointLocation({x:$(window).width()+t,y:$(window).height()+t});i=function(){var t,i,o;o=[];for(t=0,i=e.length;t<i;t++){r=e[t];if(n.lat<=r[0].lat&&r[0].lat<=s.lat&&s.lon<=r[0].lon&&r[0].lon<=n.lon){o.push(r)}}return o}();return i};return e}();n=function(e){function s(){return s.__super__.constructor.apply(this,arguments)}var t,n,r,i;N(s,e);i=[];t=[];r=[];s.prototype.update=function(){var e,t=this;if(this.zoomLevel()!==this.prevZoom||this.stops&&this.prevNumStops!==this.stops.length){this.prevNumStops=this.stops.length;this.prevZoom=this.zoomLevel();this.clusters=this.cluster(this.stops,10)}this.localClusters=this.filter(this.clusters,this.distanceInPixels());if(!this.prevLocalClusters||this.prevLocalClusters!==this.localClusters){this.prevLocalClusters=this.localClusters;e=this.selector.selectAll("g").data(this.localClusters);e.enter().append("g").append("circle").attr("class","reach").attr("r",this.distanceInPixels());e.exit().remove();this.updateCircleRadius()}return this.selector.selectAll("g").attr("transform",function(e){return t.transform(e[0])})};n=$.cookie("distance")?$.cookie("distance"):500;s.prototype.distanceInMeters=function(){if(arguments.length===0){return n}else{n=arguments[0];$.cookie("distance",n,{expires:30});m(1,"Distance",n.toString());this.updateCircleRadius();return this}};s.prototype.distanceInPixels=function(){var e;e=this.map.locationPoint({lat:0,lon:.008983}).x-this.map.locationPoint({lat:0,lon:0}).x;return this.distanceInMeters()/1e3*e};s.prototype.updateCircleRadius=function(){return this.selector.selectAll("circle.reach").attr("r",this.distanceInPixels())};s.prototype.addStops=function(e){e.sort(function(e,t){return e.lat-t.lat});this.stops=e;return this.update()};return s}(r);e=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}var t;N(n,e);t=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate("linear");n.prototype.update=function(){var e=this;return this.selector.selectAll("path").attr("d",function(t){return e.line(t)})};n.prototype.addRoutes=function(e,n){var r,i=this;r={};n.forEach(function(e){return r[e.id]=e});this.line=function(e){var n=this;return t(e.stops.map(function(e){return n.map.locationPoint(r[e.point_id])}))};return this.selector.selectAll("g").data(e).enter().append("path").attr("class","route").attr("d",function(e){return i.line(e)})};return n}(r);t=function(e){function s(){return s.__super__.constructor.apply(this,arguments)}var t,n,r,i;N(s,e);t=[];i=[];r=0;n=[];s.prototype.update=function(){var e,t=this;if(this.zoomLevel()!==this.prevZoom||this.stops&&this.prevNumStops!==this.stops.length){if(this.prevZoom&&this.zoomLevel()!==this.prevZoom){S("Zoom level changed",{"Zoom level":this.zoomLevel()})}this.prevNumStops=this.stops.length;this.prevZoom=this.zoomLevel();this.clusters=this.cluster(this.stops,10)}this.localClusters=this.filter(this.clusters,10);if(!this.prevLocalClusters||this.localClusters!==this.prevLocalClusters){e=this.selector.selectAll("g").data(this.localClusters);e.select("circle").attr("r",function(e){if(e.length>1){return 5}else{return 3.5}}).attr("text",this.representCluster);e.enter().append("g").append("circle").attr("class","stop no-tip").attr("r",function(e){if(e.length>1){return 5}else{return 3.5}}).attr("text",this.representCluster);e.exit().remove()}return this.selector.selectAll("g").attr("transform",function(e){return t.transform(e[0])})};s.prototype.representCluster=function(e){var t,n,r,i,s,o,u,a,f;r=[];for(s=0,u=e.length;s<u;s++){i=e[s];f=i.routes;for(o=0,a=f.length;o<a;o++){n=f[o];r.push(n)}}r=r.sort();r=function(){var e,i,s;s=[];for(t=e=0,i=r.length;e<i;t=++e){n=r[t];if(t=0||n!==r[t-1]){s.push(n)}}return s}();r=r.sort(function(e,t){return parseInt(e.match(/^\d+/)[0])-parseInt(t.match(/^\d+/)[0])});return"<ul>"+function(){var e,t,i;i=[];for(e=0,t=r.length;e<t;e++){n=r[e];i.push("<li>"+n+"</li>")}return i}().join("")+"</ul>"};s.prototype.addStops=function(e){e.sort(function(e,t){return e.lat-t.lat});this.stops=e;if(!Modernizr.touch){$(".stop").live("mouseover",function(e){return $(this).qtip({overwrite:false,content:{attr:"text"},show:{event:e.type,ready:true},hide:"mouseout"},e)})}return this.update()};return s}(r);i=function(e){function i(){this.rentalClass=x(this.rentalClass,this);return i.__super__.constructor.apply(this,arguments)}var t,n,r;N(i,e);i.prototype.viewedIndices=$.cookie("viewed-listings")?JSON.parse($.cookie("viewed-listings")):new Object;i.prototype.rentalClass=function(e,t){if(this.viewedIndices.hasOwnProperty(e.id)){if(e.updated_at>this.viewedIndices[e.id]){delete this.viewedIndices[e.id];return"rental"}else{return"rental rental-viewed"}}else{return"rental"}};n=$.cookie("priceLow")&&$.cookie("priceHigh")?[$.cookie("priceLow"),$.cookie("priceHigh")]:[0,3e3];i.prototype.priceRange=function(){if(arguments.length===0){return n}else{n=arguments[0];$.cookie("priceLow",n[0],{expires:30});$.cookie("priceHigh",n[1],{expires:30});m(2,"Price Low",n[0].toString());m(3,"Price High",n[1].toString());this.updateVisibility();return this}};r=$.cookie("roomsLow")&&$.cookie("roomsHigh")?[$.cookie("roomsLow"),$.cookie("roomsHigh")]:[0,5];i.prototype.roomsRange=function(){if(arguments.length===0){return r}else{r=arguments[0];$.cookie("roomsLow",r[0],{expires:30});$.cookie("roomsHigh",r[1],{expires:30});m(4,"Min Rooms",r[0].toString());m(5,"Max Rooms",r[1].toString());this.updateVisibility();return this}};t=$.cookie("showShared")?$.cookie("showShared")==="true":false;i.prototype.allowShared=function(){if(arguments.length===0){return t}else{t=arguments[0];$.cookie("showShared",t,{expires:30});this.updateVisibility();return this}};i.prototype.isNotSharedOrAllowed=function(e){var n;n=/shared|room/i.test(e.type);if(n){return t}else{return true}};i.prototype.updateVisibility=function(){var e=this;return this.selector.selectAll("rect").attr("visibility",function(t){var i,s;s=function(){var e,s,o,u,a,f;o=t.availabilities;f=[];for(e=0,s=o.length;e<s;e++){i=o[e];if(i&&n[0]<=(u=i.price)&&u<=n[1]&&r[0]<=(a=i.bedrooms)&&a<=r[1]){f.push(i)}}return f}();if(s.length>0){if(e.isNotSharedOrAllowed(t)){return"visible"}else{return"hidden"}}else{return"hidden"}})};i.prototype.update=function(){this.selector.selectAll("g").attr("transform",this.transform);return $(".rental").qtip("reposition")};i.prototype.convertDateToUTC=function(e){return new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds())};i.prototype.setListingDisplay=function(e){var t,n,r;t=function(){var t,n,i,s;i=e.availabilities;s=[];for(t=0,n=i.length;t<n;t++){r=i[t];s.push("<li>"+(r.bedrooms||r.bedrooms===0?r.bedrooms:"unknown")+" bedroom: "+(r.price>0?"$"+r.price:"Unknown")+"</li>")}return s}();n="";if(e.image_url){n=n+'<a href="'+e.url+'" target="_blank" onClick="recordOutboundLink(this, \'Outbound Links\', {"source":"'+e.source+'", "url":"'+e.url+'", "price":"'+e.url+'", "bedrooms":"'+e.bedrooms+'"})"><img class="rental-img" src="'+e.image_url+'"></a>'}n=n+e.source+", "+e.type+" <br/><ul>"+t.join("")+'</ul><br /><a href="'+e.url+"\" target=\"_blank\" onClick=\"recordOutboundLink(this, 'Outbound Links', {'source':'"+e.source+"', 'url':'"+e.url+"'});return false;\">View Original Listing</a>";return n};i.prototype.addRentals=function(e){var i,s=this;i=this.selector.selectAll("g").data(e).enter().append("g").attr("transform",this.transform);i.append("rect").attr("class",this.rentalClass).attr("x",-8/2).attr("y",-8/2).attr("height",8).attr("width",8).attr("text",function(e){return s.setListingDisplay(e)});this.updateVisibility();i.on("click",function(e,i){s.viewedIndices[e.id]=new Date*1;$.cookie("viewed-listings",JSON.stringify(s.viewedIndices),{expires:30});s.selector.selectAll("g").select("rect").attr("class",s.rentalClass);p("Rental View",e.source,e.url);return S("Rental View",{"Rental Source":e.source,url:e.url,price:e.price,bedrooms:e.bedrooms,"min price":n[0],"max price":n[1],"min rooms":r[0],"max rooms":r[1],"shared allowed":t,"zoom level":s.zoomLevel()})});return $(".rental").qtip({content:{attr:"text",title:{text:"Rental Details",button:true}},show:"mousedown",hide:false,position:{my:"bottom center",at:"top center"},style:"ui-tooltip-tipped"})};return i}(r);u=new n(c);s=new e(c);o=new t(c);v=new i(c);g=function(){var e;e=function(e){$("#slider-distance > .value").html(e+"m");return u.distanceInMeters(e)};$("#slider-distance-element").slider({range:"min",value:u.distanceInMeters(),step:10,min:0,max:2500,slide:function(t,n){return e(n.value)},stop:function(e,t){return S("distance changed",{distance:u.distanceInMeters()})}});return e($("#slider-distance-element").slider("value"))};y=function(){var e;e=function(e){$("#slider-price > .value").html("$"+e[0]+" - "+e[1]);return v.priceRange(e)};$("#slider-price-element").slider({range:true,values:v.priceRange(),step:50,min:0,max:3e3,slide:function(t,n){return e(n.values)},stop:function(e,t){return S("price changed",{"low price":v.priceRange()[0],"high price":v.priceRange()[1]})}});return e($("#slider-price-element").slider("values"))};b=function(){var e;e=function(e){$("#slider-rooms > .value").html(e[0]+" - "+e[1]+" rooms");return v.roomsRange(e)};$("#slider-rooms-element").slider({range:true,values:v.roomsRange(),min:0,max:5,slide:function(t,n){return e(n.values)},stop:function(e,t){return S("# rooms changed",{"min rooms":v.roomsRange()[0],"max rooms":v.roomsRange()[1]})}});return e($("#slider-rooms-element").slider("values"))};w=function(){$("#show-shared").attr("checked",v.allowShared());return $("#show-shared").click(function(){v.allowShared(this.checked);if(this.checked){return S("shared selected")}else{return S("private selected")}})};f=function(){return d3.json("data/uvic_transit.json",function(e){u.addStops(e.stops);s.addRoutes(e.routes,e.stops);return o.addStops(e.stops)})};l=function(){return d3.json("data/rentals.json",function(e){return v.addRentals(e)})};(function(){g();y();b();w();f();l();return S("RentalMap loaded")})();$(window).unload(function(){return S("RentalMap closed")});addthis.addEventListener("addthis.menu.share",function(e){return S("AddThis",e.data)});$("a[rel*='external']").click(function(){var e;e=$(this);p("External Link",e.text(),e.attr("href"));return S("External Link",{"Link Text":e.text(),url:e.attr("href")})});$("#loading").hide()}else{$("#unsupportedBrowser").show();$(".regular").hide();p("Unsupported Browser","No SVG",navigator.userAgent);S("Unsupported Browser",{Browser:navigator.userAgent})}}).call(this)
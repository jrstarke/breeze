(function(){var t,e,r,n,o,i,s,a,l,u,c,p,d,h,m,f,g,v,w,y,k,x,b,L,C,_,S,R=function(t,e){return function(){return t.apply(e,arguments)}},M={}.hasOwnProperty,z=function(t,e){function r(){this.constructor=t}for(var n in e)M.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};y=Modernizr.touch?12:8,a=3.5,i=5,p=function(t,e){return t.forEach(function(t){var r;return r=e[t.p],t.lat=r.lat,t.lon=r.lon})},S=function(t,e,r){return null==r&&(r=null),mixpanel.track(t,e),r?r():void 0},v=function(t,e,r){return g(e,r.source,r.url),S(e,r,function(){return window.open(t.href,"_blank")})},window.recordOutboundLink=v,g=function(t,e,r){return _gat._getTrackerByName()._trackEvent(t,e,r)},window.recordEvent=g,k=function(t,e,r){return _gaq.push(["_setCustomVar",t,e,r,2])},window.setVariable=k,Modernizr.svg&&Modernizr.inlinesvg?(($(window).height()<500||$(window).width()<500)&&$(".desktop").hide(),$(window).width()<600||$.cookie("survey-closed")||$.cookie("survey-visited")||$(".message").show(),Modernizr.touch&&$(".github").hide(),$(".header").show(),c=function(t){return $("#standard-options").is(":visible")?($("#standard-options").hide("slow"),$(t).button("option","icons",{primary:"ui-icon-triangle-1-s"}),S("hid options")):($("#standard-options").show("slow"),$(t).button("option","icons",{primary:"ui-icon-triangle-1-n"}),S("show options"))},$(".header-expand").button({icons:{primary:"ui-icon ui-icon-triangle-1-n"},text:!1}).click(function(){return c(this)}),_=function(){return $("#additional-notices").is(":visible")?($("#additional-notices").hide("slow"),$("a#additional-expand").text("additional notices"),S("hid notices")):($("#additional-notices").show("slow"),$("a#additional-expand").text("less notices"),S("show notices"))},$("a#additional-expand").click(function(){return _()}),f=org.polymaps,m=f.map().container(d3.select("#map").append("svg:svg").attr("width","100%").attr("height","100%").node()).zoom(13).center({lat:48.455164,lon:-123.351059}).add(f.drag()).add(f.wheel().smooth(!1)).add(f.dblclick()).add(f.arrow()).add(f.touch()),m.add(f.image().url(f.url("http://tile.stamen.com/toner/{Z}/{X}/{Y}.png"))),n=function(){function t(t){var e=this;this.map=t,this.transform=R(this.transform,this),this.selector=d3.select("#map svg").insert("svg:g"),this.map.on("move",function(){return e.update()}),this.map.on("resize",function(){return e.update()})}return t.prototype.zoomLevel=function(){return this.map.zoom()},t.prevZoom=13,t.distance=0,t.prototype.pixelDistance=function(){var t,e;return t=this.map.pointLocation({x:0,y:0}),e=this.map.pointLocation({x:1,y:1}),this.distance={lat:Math.abs(t.lat-e.lat),lon:Math.abs(t.lon-e.lon)},this.distance},t.prototype.transform=function(t){var e;return e=this.map.locationPoint(t),"translate("+e.x+","+e.y+")"},t.prototype.cluster=function(t,e){var r,n,o,i,s,a,l,u,c;for(i=t.slice(0),u=this.pixelDistance(),s=e*u.lat,a=e*u.lon,o=[];i.length>0;){for(c=i.shift(),n=[],n.push(c),l=0;l<i.length;)Math.abs(i[l].lat-c.lat)<s&&Math.abs(i[l].lon-c.lon)<a&&(r=i.splice(l,1),n.push(r[0]),l--),l++;o.push(n)}return o},t.prototype.filter=function(t,e){var r,n,o,i;return i=this.map.pointLocation({x:0-e,y:0-e}),r=this.map.pointLocation({x:$(window).width()+e,y:$(window).height()+e}),o=function(){var e,o,s;for(s=[],e=0,o=t.length;o>e;e++)n=t[e],r.lat<=n[0].lat&&n[0].lat<=i.lat&&i.lon<=n[0].lon&&n[0].lon<=r.lon&&s.push(n);return s}()},t}(),r=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}var r,n,o,i;return z(e,t),i=[],r=[],o=[],e.prototype.update=function(){var t,e=this;return(this.zoomLevel()!==this.prevZoom||this.stops&&this.prevNumStops!==this.stops.length)&&(this.prevNumStops=this.stops.length,this.prevZoom=this.zoomLevel(),this.clusters=this.cluster(this.stops,10)),this.localClusters=this.filter(this.clusters,this.distanceInPixels()),this.prevLocalClusters&&this.prevLocalClusters===this.localClusters||(this.prevLocalClusters=this.localClusters,t=this.selector.selectAll("g").data(this.localClusters),t.enter().append("g").append("circle").attr("class","reach").attr("r",this.distanceInPixels()),t.exit().remove(),this.updateCircleRadius()),this.selector.selectAll("g").attr("transform",function(t){return e.transform(t[0])})},n=$.cookie("distance")?$.cookie("distance"):500,e.prototype.distanceInMeters=function(){return 0===arguments.length?n:(n=arguments[0],$.cookie("distance",n,{expires:30}),k(1,"Distance",n.toString()),this.updateCircleRadius(),this)},e.prototype.distanceInPixels=function(){var t;return t=this.map.locationPoint({lat:0,lon:.008983}).x-this.map.locationPoint({lat:0,lon:0}).x,this.distanceInMeters()/1e3*t},e.prototype.updateCircleRadius=function(){return this.selector.selectAll("circle.reach").attr("r",this.distanceInPixels())},e.prototype.addStops=function(t){return t.sort(function(t,e){return t.lat-e.lat}),this.stops=t,this.update()},e}(n),t=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}var r;return z(e,t),r=d3.svg.line().x(function(t){return t.x}).y(function(t){return t.y}).interpolate("linear"),e.prototype.update=function(){var t=this;return this.selector.selectAll("path").attr("d",function(e){return t.line(e)})},e.prototype.addRoutes=function(t,e){var n=this;return this.line=function(t){var n=this;return r(t.map(function(t){return n.map.locationPoint(e[t])}))},this.selector.selectAll("g").data(t).enter().append("path").attr("class","route").attr("d",function(t){return n.line(t)})},e}(n),e=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}var r,n,o,s;return z(e,t),r=[],s=[],o=0,n=[],e.prototype.update=function(){var t,e=this;return(this.zoomLevel()!==this.prevZoom||this.stops&&this.prevNumStops!==this.stops.length)&&(this.prevZoom&&this.zoomLevel()!==this.prevZoom&&S("Zoom level changed",{"Zoom level":this.zoomLevel()}),this.prevNumStops=this.stops.length,this.prevZoom=this.zoomLevel(),this.clusters=this.cluster(this.stops,10)),this.localClusters=this.filter(this.clusters,10),this.prevLocalClusters&&this.localClusters===this.prevLocalClusters||(t=this.selector.selectAll("g").data(this.localClusters),t.select("circle").attr("r",function(t){return t.length>1?i:a}).attr("text",this.representCluster),t.enter().append("g").append("circle").attr("class","stop no-tip").attr("r",function(t){return t.length>1?i:a}).attr("text",this.representCluster),t.exit().remove()),this.selector.selectAll("g").attr("transform",function(t){return e.transform(t[0])})},e.prototype.representCluster=function(t){var e,r,n,o,i,s,a,l,u;for(n=[],i=0,a=t.length;a>i;i++)for(o=t[i],u=o.routes,s=0,l=u.length;l>s;s++)r=u[s],n.push(r);return n=n.sort(),n=function(){var t,o,i;for(i=[],e=t=0,o=n.length;o>t;e=++t)r=n[e],(e=0||r!==n[e-1])&&i.push(r);return i}(),n=n.sort(function(t,e){return parseInt(t.match(/^\d+/)[0])-parseInt(e.match(/^\d+/)[0])}),"<ul>"+function(){var t,e,o;for(o=[],t=0,e=n.length;e>t;t++)r=n[t],o.push("<li>"+r+"</li>");return o}().join("")+"</ul>"},e.prototype.addStops=function(t){return t.sort(function(t,e){return t.lat-e.lat}),this.stops=t,Modernizr.touch||$(".stop").live("mouseover",function(t){return $(this).qtip({overwrite:!1,content:{attr:"text"},show:{event:t.type,ready:!0},hide:"mouseout"},t)}),this.update()},e}(n),o=function(t){function e(){return this.rentalClass=R(this.rentalClass,this),e.__super__.constructor.apply(this,arguments)}var r,n,o;return z(e,t),e.prototype.viewedIndices=$.cookie("viewed-listings")?JSON.parse($.cookie("viewed-listings")):new Object,e.prototype.rentalClass=function(t){return this.viewedIndices.hasOwnProperty(t.id)?t.updated_at>this.viewedIndices[t.id]?(delete this.viewedIndices[t.id],"rental"):"rental rental-viewed":"rental"},n=$.cookie("priceLow")&&$.cookie("priceHigh")?[$.cookie("priceLow"),$.cookie("priceHigh")]:[0,3e3],e.prototype.priceRange=function(){return 0===arguments.length?n:(n=arguments[0],$.cookie("priceLow",n[0],{expires:30}),$.cookie("priceHigh",n[1],{expires:30}),k(2,"Price Low",n[0].toString()),k(3,"Price High",n[1].toString()),this.updateVisibility(),this)},o=$.cookie("roomsLow")&&$.cookie("roomsHigh")?[$.cookie("roomsLow"),$.cookie("roomsHigh")]:[0,5],e.prototype.roomsRange=function(){return 0===arguments.length?o:(o=arguments[0],$.cookie("roomsLow",o[0],{expires:30}),$.cookie("roomsHigh",o[1],{expires:30}),k(4,"Min Rooms",o[0].toString()),k(5,"Max Rooms",o[1].toString()),this.updateVisibility(),this)},r=$.cookie("showShared")?"true"===$.cookie("showShared"):!1,e.prototype.allowShared=function(){return 0===arguments.length?r:(r=arguments[0],$.cookie("showShared",r,{expires:30}),this.updateVisibility(),this)},e.prototype.isNotSharedOrAllowed=function(t){var e;return e=/shared|room/i.test(t.type),e?r:!0},e.prototype.updateVisibility=function(){var t=this;return this.selector.selectAll("rect").attr("visibility",function(e){var r,i;return i=function(){var t,i,s,a,l,u;for(s=e.availabilities,u=[],t=0,i=s.length;i>t;t++)r=s[t],r&&n[0]<=(a=r.price)&&a<=n[1]&&o[0]<=(l=r.bedrooms)&&l<=o[1]&&u.push(r);return u}(),i.length>0&&t.isNotSharedOrAllowed(e)?"visible":"hidden"})},e.prototype.update=function(){return this.selector.selectAll("g").attr("transform",this.transform),$(".rental").qtip("reposition")},e.prototype.convertDateToUTC=function(t){return new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds())},e.prototype.setListingDisplay=function(t){var e,r,n;return e=function(){var e,r,o,i;for(o=t.availabilities,i=[],e=0,r=o.length;r>e;e++)n=o[e],i.push("<li>"+(n.bedrooms||0===n.bedrooms?n.bedrooms:"unknown")+" bedroom: "+(n.price>0?"$"+n.price:"Unknown")+"</li>");return i}(),r="",t.image_url&&(r=r+'<a href="'+t.url+'" target="_blank" onClick="recordOutboundLink(this, \'Outbound Links\', {"source":"'+t.source+'", "url":"'+t.url+'", "price":"'+t.url+'", "bedrooms":"'+t.bedrooms+'"})"><img class="rental-img" src="'+t.image_url+'"></a>'),r=r+t.source+", "+t.type+" <br/><ul>"+e.join("")+'</ul><br /><a href="'+t.url+"\" target=\"_blank\" onClick=\"recordOutboundLink(this, 'Outbound Links', {'source':'"+t.source+"', 'url':'"+t.url+"'});return false;\">View Original Listing</a>"},e.prototype.addRentals=function(t){var e,i=this;return e=this.selector.selectAll("g").data(t).enter().append("g").attr("transform",this.transform),e.append("rect").attr("class",this.rentalClass).attr("x",-1*y/2).attr("y",-1*y/2).attr("height",y).attr("width",y).attr("text",function(t){return i.setListingDisplay(t)}),this.updateVisibility(),e.on("click",function(t){return i.viewedIndices[t.id]=1*new Date,$.cookie("viewed-listings",JSON.stringify(i.viewedIndices),{expires:30}),i.selector.selectAll("g").select("rect").attr("class",i.rentalClass),g("Rental View",t.source,t.url),S("Rental View",{"Rental Source":t.source,url:t.url,price:t.price,bedrooms:t.bedrooms,"min price":n[0],"max price":n[1],"min rooms":o[0],"max rooms":o[1],"shared allowed":r,"zoom level":i.zoomLevel()})}),$(".rental").qtip({content:{attr:"text",title:{text:"Rental Details",button:!0}},show:"mousedown",hide:!1,position:{my:"bottom center",at:"top center"},style:"ui-tooltip-tipped"})},e}(n),u=new r(m),s=new t(m),l=new e(m),w=new o(m),x=function(){var t;return t=function(t){return $("#slider-distance > .value").html(t+"m"),u.distanceInMeters(t)},$("#slider-distance-element").slider({range:"min",value:u.distanceInMeters(),step:10,min:0,max:2500,slide:function(e,r){return t(r.value)},stop:function(){return S("distance changed",{distance:u.distanceInMeters()})}}),t($("#slider-distance-element").slider("value"))},b=function(){var t;return t=function(t){return $("#slider-price > .value").html("$"+t[0]+" - "+t[1]),w.priceRange(t)},$("#slider-price-element").slider({range:!0,values:w.priceRange(),step:50,min:0,max:3e3,slide:function(e,r){return t(r.values)},stop:function(){return S("price changed",{"low price":w.priceRange()[0],"high price":w.priceRange()[1]})}}),t($("#slider-price-element").slider("values"))},L=function(){var t;return t=function(t){return $("#slider-rooms > .value").html(t[0]+" - "+t[1]+" rooms"),w.roomsRange(t)},$("#slider-rooms-element").slider({range:!0,values:w.roomsRange(),min:0,max:5,slide:function(e,r){return t(r.values)},stop:function(){return S("# rooms changed",{"min rooms":w.roomsRange()[0],"max rooms":w.roomsRange()[1]})}}),t($("#slider-rooms-element").slider("values"))},C=function(){return $("#show-shared").attr("checked",w.allowShared()),$("#show-shared").click(function(){return w.allowShared(this.checked),S(this.checked?"shared selected":"private selected")})},d=function(){return d3.json("data/uvic_transit.json",function(t){var e;return e={},t.points.forEach(function(t){return e[t.id]=t}),p(t.stops,e),u.addStops(t.stops),s.addRoutes(t.routes,e),l.addStops(t.stops)})},h=function(){return d3.json("data/rentals.json",function(t){return w.addRentals(t)})},function(){return x(),b(),L(),C(),d(),h(),S("RentalMap loaded")}(),$(window).unload(function(){return S("RentalMap closed")}),$(".message .close").on("click",function(){return $(".message").hide(),$.cookie("survey-closed",!0,{expires:5}),S("Survey Closed")}),$(window).on("resize",function(){return $(window).width()<600?$(".message").hide():$(".message").show()}),addthis.addEventListener("addthis.menu.share",function(t){return S("AddThis",t.data)}),$("a[rel*='external']").click(function(){var t;return t=$(this),g("External Link",t.text(),t.attr("href")),S("External Link",{"Link Text":t.text(),url:t.attr("href")})}),$("#loading").hide()):($("#unsupportedBrowser").show(),$(".regular").hide(),g("Unsupported Browser","No SVG",navigator.userAgent),S("Unsupported Browser",{Browser:navigator.userAgent}))}).call(this);